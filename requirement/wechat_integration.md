
# 微信服务号登录进入候选人端系统需求文档

## 1. 背景说明
目前系统已具备：
- HR 管理端可录入候选人的 **姓名 + 手机号 + 基本信息**。
- 当前项目(候选人端)已开发完成，候选人可通过 **手机号登录** 填写简历。
- HR 管理端可以生成候选人填写的链接。

现在新增需求：  
**基于微信服务号，让候选人从服务号菜单/自动回复/消息入口进入 H5 系统，并完成统一的微信授权登录流程，与现有手机号登录体系融合。**

---

# 2. 目标（业务）
1. 候选人必须先被 HR在管理端 录入后(手机号必填)才能进入填写界面。
2. 候选人关注服务号 → 点击菜单（如“填写简历”） → 自动跳转至系统。
3. 系统自动获取候选人微信身份（OpenID/UnionID），并与后台的手机号绑定。
4. 已被 HR 录入的候选人无需 HR 再发送邀请链接，即可自主在服务号中进入填写界面。
5. 未经HR录入或未授权的候选人不能自行填写，系统应提示：“请联系 HR 获取录入权限”。

---

# 3. 候选人从服务号进入系统的总体流程

```
候选人关注服务号
       ↓
点击菜单/自动回复进入 H5 授权页
       ↓
系统获取 openid（OAuth）
       ↓
系统检查是否已有 openid → 手机号绑定关系
       ↓
  ┌──────────────┬─────────────────────┐
  │ 已绑定手机号 │      未绑定手机号    │
  └──────────────┴─────────────────────┘
       ↓                           ↓
直接进入简历填写页       触发微信手机号授权（JS SDK）
                                    ↓
                         微信弹窗请求授权获取手机号
                                    ↓
                        微信返回手机号（极高准确度）
                                    ↓
                    后端检查此手机号是否被 HR 录入
                                    ↓
                    ┌──────────────┬─────────────────────┐
                    │ 已录入（允许）│   未录入（拒绝）    │
                    └──────────────┴─────────────────────┘
                           ↓                     ↓
                 建立 openid ↔ 手机号绑定     显示“请联系 HR”
                           ↓
                     进入简历填写页
```

---

# 4. 详细功能需求

## 4.1 服务号配置需求
### 功能项
1. **自定义菜单：**
    - 菜单项：“填写简历 / Resume”
    - 点击菜单跳转到系统 H5 的微信 OAuth 授权链接

2. **消息自动回复：**
    - 用户关注服务号后自动回复：“点击此处进入简历填写”
    - 回复中包含相同的 OAuth 链接

3. **OAuth 配置：**
    - 微信开放平台配置授权回调域名（H5 域名）
    - 使用 `snsapi_userinfo`（可获取头像昵称等）
    - 或 `snsapi_base`（只获取 OpenID）

---

## 4.2 微信授权流程需求（后端）

### 4.2.1 系统获取微信身份
待补充

### 4.2.2 系统逻辑判断
后端根据 `openid` 判断：

① 已绑定（openid ↔ 手机号 已存在）
•	系统找到已绑定关系
•	校验该手机号对应的候选人recordStatus是否处于“填写中”(editing)状态
•	条件满足 → 直接进入填写页面
•	若状态不允许 → 提示“您已填写或无权限填写”

② 未绑定，但微信授权返回的手机号在 HR 库中
（即：首次访问，但用户确实是 HR 录入的候选人）
流程：
1.	微信授权 → 系统获取手机号：如 138xxxx0001
2.	查询 HR 数据库 → 找到候选人记录
3.	建立绑定关系：openid ↔ 手机号
4.	跳转进入填写界面
➡ 这属于 合法候选人首次进入系统，自动完成绑定，无需额外操作。

③ 未绑定，且微信授权返回的手机号 不在 HR 库中
（即“外部用户”或“未经过 HR 审核录入的人”）
在这种情况下必须 拒绝填写。
系统行为：
1.	微信授权获取手机号
2.	后端对手机号进行数据库匹配 → 未找到
3.	返回错误提示：
“您尚未被 HR 录入，无法填写信息，请联系 HR。”
4.	页面可引导用户联系 HR 或返回首页
（绝不能让陌生人填写进入系统）

# 5. 对 HR 后台的影响（新增字段）
为了支持服务号登录，需要对候选人表新增字段：

| 字段            | 说明 |
|---------------|------|
| wechat_openid | 候选人的微信 openid |


新增功能：  
**“重置微信绑定”**：释放 openid 与手机号的绑定关系。

---

# 6. 非功能性要求
- 微信授权跳转耗时控制 < 3 seconds
- 页面必须支持微信内置浏览器
- 需兼容 iOS 与 Android

---

# 7. 总结（最核心流程）
1. 候选人关注服务号
2. 点击菜单 → 进入 OAuth 授权
3. 系统获取 openid
4. 判断是否已绑定手机号
    - 已绑定 → 直接进入填写页
    - 未绑定 → 手机号验证
5. 与 HR 录入手机号匹配
6. 匹配成功 → 建立绑定 → 填写
7. 匹配失败 → 提示“请联系HR”
